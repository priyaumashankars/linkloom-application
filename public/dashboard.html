<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Dashboard</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f2f5;
            margin: 0;
        }
        .navbar {
            background-color: #9525b8;
            padding: 10px;
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 1000;
        }
        .navbar-brand {
            color: white;
            font-weight: bold;
        }
        .navbar-nav .nav-link {
            color: white;
            margin-right: 15px;
        }
        .navbar-nav .nav-link:hover {
            color: #d4d5d7;
        }
        .search-bar {
            width: 300px;
            margin: auto;
        }
        .search-input {
            border-radius: 50px;
            padding: 10px;
            border: none;
            width: 100%;
        }
        .main-feed {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .sidebar-column {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .sidebar-column h5 {
            font-weight: bold;
            margin-bottom: 15px;
        }
        .sidebar-column ul {
            list-style-type: none;
            padding: 0;
        }
        .sidebar-column ul li {
            margin-bottom: 10px;
        }
        .sidebar-column ul li a {
            text-decoration: none;
            color: #b989e0;
            font-weight: bold;
        }
        .sidebar-column ul li a:hover {
            color: #b989e0;
        }
        .btn-primary {
            background-color: #b989e0;
            border-color: #b989e0;
        }
        .btn-primary:hover {
            background-color: #b989e0;
            border-color: #b989e0;
        }
        footer {
            background-color: #b989e0;
            color: white;
            text-align: center;
            padding: 10px;
            position: fixed;
            bottom: 0;
            width: 100%;
        }
        .welcome-message {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 20px;
        }
        .main-content {
            margin-top: 80px;
        }
        .left-sidebar, .right-sidebar {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .left-sidebar ul, .right-sidebar ul {
            list-style: none;
            padding: 0;
        }
        .left-sidebar ul li, .right-sidebar ul li {
            margin-bottom: 10px;
        }
        .left-sidebar ul li a, .right-sidebar ul li a {
            text-decoration: none;
            color: #4267B2;
        }
        .left-sidebar ul li a:hover, .right-sidebar ul li a:hover {
            color: #365899;
        }
        .post {
            border-bottom: 1px solid #ddd;
            padding-bottom: 10px;
            margin-bottom: 10px;
        }
        .post img {
            max-width: 100%;
            height: auto;
        }
        .like-button, .dislike-button, .comment-button {
            margin-top: 10px;
        }
        .comments {
            margin-top: 10px;
        }
        .comment {
            border-top: 1px solid #ddd;
            padding-top: 5px;
        }
        .post-author {
            font-weight: bold;
            margin-bottom: 5px;
        }
        body {
            background-image: url('logo.jpg');
            background-size: cover;  /* Cover the entire page */
            background-position: center;  /* Center the image */
            background-repeat: no-repeat;  /* Prevent repeating the image */
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <a class="navbar-brand" href="#">LINKLOOM</a>
        <div class="collapse navbar-collapse">
            <div class="search-bar mx-auto">
                <input type="text" class="search-input" placeholder="Search">
            </div>
            <ul class="navbar-nav ml-auto">
                <li class="nav-item">
                    <a class="nav-link" href="#">Home</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/profile.html">Profile</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" id="logoutButton">Logout</a>
                </li>
            </ul>
        </div>
    </nav>
    
    <div class="container main-content">
        <div class="welcome-message">
            <label for="fullName" class="form-label">Welcome, <span id="fullName"></span>!</label>
        </div>
        <div class="row">
            <!-- Left Sidebar -->
            <div class="col-lg-3">
                <div class="left-sidebar">
                    <h5>Friends</h5>
                    <ul id="friendsList">
                        <!-- Friends will be populated here -->
                    </ul>
                    <h5>Groups</h5>
                    <ul id="groupsList">
                        <!-- Groups will be populated here -->
                    </ul>
                    <h5>Pages</h5>
                    <ul id="pagesList">
                        <!-- Pages will be populated here -->
                    </ul>
                </div>
            </div>
 
            <!-- Main Feed -->
            <div class="col-lg-6">
                <!-- Form to create a new post -->
                <form id="postForm">
                    <div class="mb-3">
                        <textarea id="postText" class="form-control" placeholder="What's on your mind?" required></textarea>
                    </div>
                    <div class="mb-3">
                        <input type="file" id="postImage" class="form-control" accept="image/*">
                    </div>
                    <button type="submit" class="btn btn-primary">Post</button>
                </form>
                <hr>
                <!-- Posts will be displayed here -->
                <div id="postsContainer"></div>
            </div>

        </div>
    </div>
 
    <footer>
        &copy; 2024 User Dashboard App
    </footer>
 
    <!-- Bootstrap JS and dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>
 
    <script>
    document.addEventListener('DOMContentLoaded', async () => {
        const fullNameSpan = document.getElementById('fullName');
        const token = localStorage.getItem('token');

        if (!token) {
            alert('You must be logged in to view this page.');
            window.location.href = '/login.html';
            return;
        }

        // Fetch and display user information
        const fullName = localStorage.getItem('fullName');
        if (fullName) {
            fullNameSpan.textContent = fullName;
        } else {
            console.error('Full Name not found in localStorage');
        }

        try {
            // Fetch user info from the /protected endpoint
            const userResponse = await fetch('/protected', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (userResponse.ok) {
                const user = await userResponse.json();

                // Fetch friends, groups, and pages (mocked as example)
                const friends = ['Friend 1', 'Friend 2', 'Friend 3'];
                const groups = ['Group 1', 'Group 2', 'Group 3'];
                const pages = ['Page 1', 'Page 2', 'Page 3'];

                document.getElementById('friendsList').innerHTML = friends.map(friend => `<li><a href="#">${friend}</a></li>`).join('');
                document.getElementById('groupsList').innerHTML = groups.map(group => `<li><a href="#">${group}</a></li>`).join('');
                document.getElementById('pagesList').innerHTML = pages.map(page => `<li><a href="#">${page}</a></li>`).join('');

                // Fetch posts from the server
                const postsResponse = await fetch('/posts', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (postsResponse.ok) {
                    const posts = await postsResponse.json();
                    const postsContainer = document.getElementById('postsContainer');
                    postsContainer.innerHTML = posts.map(post => `
                        <div class="post" id="post-${post.id}">
                            <div class="post-author">${fullName}</div>
                            <p>${post.text}</p>
                            ${post.image ? `<img src="${post.image}" alt="Post Image">` : ''}
                            <button class="btn btn-secondary like-button" onclick="likePost(${post.id})">Like</button>
                            <button class="btn btn-secondary dislike-button" onclick="dislikePost(${post.id})">Dislike</button>
                            <div class="comments">
                                <div class="comment">
                                    <input type="text" placeholder="Add a comment" id="comment-${post.id}">
                                    <button class="btn btn-secondary comment-button" onclick="addComment(${post.id})">Comment</button>
                                </div>
                                <!-- Comments will be populated here -->
                                <div id="comments-${post.id}"></div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    console.error('Failed to fetch posts');
                }
            } else {
                console.error('Failed to fetch user info');
            }
        } catch (error) {
            console.error('Error:', error);
        }
    });

    document.getElementById('postForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const token = localStorage.getItem('token');
        if (!token) {
            alert('You must be logged in to create a post.');
            return;
        }

        const postText = document.getElementById('postText').value;
        const postImage = document.getElementById('postImage').files[0];

        const formData = new FormData();
        formData.append('text', postText);
        if (postImage) formData.append('image', postImage);

        try {
            const response = await fetch('/posts', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`
                },
                body: formData
            });

            if (response.ok) {
                const newPost = await response.json();
                addPostToFeed(newPost);
                document.getElementById('postText').value = '';
                document.getElementById('postImage').value = '';
            } else {
                console.error('Failed to create post');
            }
        } catch (error) {
            console.error('Error:', error);
        }
    });

    function addPostToFeed(post) {
        const fullName = localStorage.getItem('fullName');
        const postsContainer = document.getElementById('postsContainer');
        postsContainer.innerHTML += `
            <div class="post" id="post-${post.id}">
                <div class="post-author">${fullName}</div>
                <p>${post.text}</p>
                ${post.image ? `<img src="${post.image}" alt="Post Image">` : ''}
                <button class="btn btn-secondary like-button" onclick="likePost(${post.id})">Like</button>
                <button class="btn btn-secondary dislike-button" onclick="dislikePost(${post.id})">Dislike</button>
                <div class="comments">
                    <div class="comment">
                        <input type="text" placeholder="Add a comment" id="comment-${post.id}">
                        <button class="btn btn-secondary comment-button" onclick="addComment(${post.id})">Comment</button>
                    </div>
                    <!-- Comments will be populated here -->
                    <div id="comments-${post.id}"></div>
                </div>
            </div>
        `;
    }

    async function likePost(postId) {
        const token = localStorage.getItem('token');
        if (!token) {
            alert('You must be logged in to like a post.');
            return;
        }

        try {
            const response = await fetch(`/posts/${postId}/like`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (response.ok) {
                alert('Post liked successfully');
            } else {
                const error = await response.json();
                alert(error.error);
            }
        } catch (error) {
            console.error('Error:', error);
        }
    }

    async function dislikePost(postId) {
        const token = localStorage.getItem('token');
        if (!token) {
            alert('You must be logged in to dislike a post.');
            return;
        }

        try {
            const response = await fetch(`/posts/${postId}/dislike`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (response.ok) {
                alert('Post disliked successfully');
            } else {
                const error = await response.json();
                alert(error.error);
            }
        } catch (error) {
            console.error('Error:', error);
        }
    }

    async function addComment(postId) {
    const token = localStorage.getItem('token');
    if (!token) {
        alert('You must be logged in to comment on a post.');
        return;
    }

    const commentInput = document.getElementById(`comment-${postId}`);
    const commentText = commentInput.value.trim();  // Trim whitespace

    if (!commentText) {
        alert('Comment cannot be empty.');
        return;
    }

    try {
        const response = await fetch(`/posts/${postId}/comments`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ comment: commentText })
            
        });
        if (response.ok) {
                alert('Comment added to the post successfully');
            } else {
                const error = await response.json();
                alert(error.error);
            }

        if (response.ok) {
            commentInput.value = '';  // Clear the input field
            const commentsDiv = document.getElementById(`comments-${postId}`);
            commentsDiv.innerHTML += `<div class="comment">${commentText}</div>`;
        
        } else {
            const error = await response.json();
            alert(error.error);
        } 
        
    } catch (error) {
        console.error('Error:', error);
    }
}
    document.getElementById('logoutButton').addEventListener('click', () => {
        localStorage.removeItem('token');
        localStorage.removeItem('fullName');
        window.location.href = '/login.html';
    });
    </script>
</body>
</html>
